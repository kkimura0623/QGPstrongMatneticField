module polygamma_mod
  implicit none
  private
  public ::   digamma
  public :: polygamma
  integer, parameter :: DP=KIND(1.0d0)
  integer, parameter :: QP=KIND(1.0d0)

contains

function digamma(x) result(dgf)
  real(DP), intent(in) :: x
  real(DP) :: dgf
  dgf = polygamma(0,x)
  return
end function

function polygamma(n,x) result(pgf)
  integer, intent(in) :: n
  real(DP), intent(in) :: x
  real(DP) :: pgf
  real(QP) :: f
  real(QP) :: y,z,y2,y3,y4,y5,y6,y7,y8,y9,y10
  integer, parameter :: nmax=8
  real(QP), parameter :: xt(0:nmax) = [47.0_QP,60.0_QP,57.0_QP,73.0_QP,68.0_QP,88.0_QP,82.0_QP,107.0_QP,98.0_QP]
  integer :: j,k

  if ( n < 0 ) then
    write(*,'("polyganmma(n,x): negative n error.! n=",I3)')n
    stop
  endif
  if ( n > nmax ) then
    write(*,'("polyganmma(n,x): n should be less than 10 incurrent inplementation. n=",I3)')n
    stop
  endif
  if ( x <= 0.0_QP ) then
    write(*,'("polyganmma(n,x): negative or zero x error.! x=",ES24.15)')x
    stop
  endif

  f = 0.0_QP

  if ( x <= xt(n) ) then

    j = Ceiling(xt(n) - x)
    do k=j-1,0,-1
      f = f + (1.0_QP/(x + k))**(n+1)
    enddo
    y = 1.0_QP/(x + j)
    do k =1,n
      f = -k*f
    enddo
    f = -f
  else
    y = 1.0_QP/x
  endif

  y2 = y*y

  select case(n)
  case (0)

  f = f - Log(y)        &
 &  + y   *(-0.5_QP     &
 &  + y   *(-0.08333333333333333333333333333333333333333333333333333333333333333_QP   &
 &  + y2  *( 0.008333333333333333333333333333333333333333333333333333333333333333_QP  &
 &  + y2  *(-0.003968253968253968253968253968253968253968253968253968253968253968_QP  &
 &  + y2  *( 0.004166666666666666666666666666666666666666666666666666666666666667_QP  &
 &  + y2  *(-0.007575757575757575757575757575757575757575757575757575757575757576_QP  &
 &  + y2  *( 0.02109279609279609279609279609279609279609279609279609279609279609_QP   &
 &  + y2  *(-0.08333333333333333333333333333333333333333333333333333333333333333_QP   &
 &  + y2  *( 0.4432598039215686274509803921568627450980392156862745098039215686_QP    &
 &  + y2  *(-3.05395433027011974380395433027011974380395433027011974380395433_QP      &
 &  + y2  *(26.45621212121212121212121212121212121212121212121212121212121212)))))))))))

  case (1)

  f = f + y   *( 1.0_QP  &
 &      + y   *( 0.5_QP  &
 &      + y   *( 0.1666666666666666666666666666666666666666666666666666666666666667_QP   &
 &      + y2  *(-0.03333333333333333333333333333333333333333333333333333333333333333_QP  &
 &      + y2  *( 0.02380952380952380952380952380952380952380952380952380952380952381_QP  &
 &      + y2  *(-0.03333333333333333333333333333333333333333333333333333333333333333_QP  &
 &      + y2  *( 0.07575757575757575757575757575757575757575757575757575757575757576_QP  &
 &      + y2  *(-0.2531135531135531135531135531135531135531135531135531135531135531_QP   &
 &      + y2  *( 1.166666666666666666666666666666666666666666666666666666666666667_QP    &
 &      + y2  *(-7.092156862745098039215686274509803921568627450980392156862745098_QP    &
 &      + y2  *(54.97117794486215538847117794486215538847117794486215538847117794_QP )))))))))))

  case(2)
  f = f + y2  *(-1.0_QP    &
 &      + y   *(-1.0_QP    &
 &      + y   *(-0.5_QP   &
 &      + y2  *( 0.1666666666666666666666666666666666666666666666666666666666666667_QP   &
 &      + y2  *(-0.1666666666666666666666666666666666666666666666666666666666666667_QP   &
 &      + y2  *( 0.3_QP    &
 &      + y2  *(-0.8333333333333333333333333333333333333333333333333333333333333333_QP   &
 &      + y2  *( 3.29047619047619047619047619047619047619047619047619047619047619_QP     &
 &      + y2  *(-17.5_QP   &
 &      + y2  *(120.5666666666666666666666666666666666666666666666666666666666667_QP     &
 &      - y2  *(1044.452380952380952380952380952380952380952380952380952380952381_QP)))))))))))
  case(3)
  y3 = y2*y
  f = f + y3  *( 2.0_QP   &
 &      + y   *( 3.0_QP   &
 &      + y   *( 2.0_QP   &
 &      + y2  *(-1.0_QP   &
 &      + y2  *( 1.333333333333333333333333333333333333333333333333333333333333333_QP   &
 &      + y2  *(-3.0_QP   &
 &      + y2  *(10.0_QP   &
 &      + y2  *(-46.06666666666666666666666666666666666666666666666666666666666667_QP   &
 &      + y2  *(280.0_QP - 2170.2_QP*y**2)))))))))
  case(4)
  y4 = y2*y2
  f = f + y4  *(-6.0_QP     &
 &      + y   *(-12.0_QP    &
 &      + y   *(-10.0_QP    &
 &      + y2  *( 7.0_QP     &
 &      + y2  *(-12.0_QP    &
 &      + y2  *( 33.0_QP    &
 &      + y2  *(-130.0_QP   &
 &      + y2  *( 691.0_QP   &
 &      + y2  *(-4760.0_QP  &
 &      + y2  *( 41233.80_QP))))))))))
  case(5)
  y4 = y2*y2
  y5 = y4*y
  f = f + y5  *( 24.0_QP    &
 &      + y   *( 60.0_QP    &
 &      + y   *( 60.0_QP    &
 &      + y2  *(-56.0_QP    &
 &      + y2  *( 120.0_QP   &
 &      + y2  *(-396.0_QP   &
 &      + y2  *( 1820.0_QP  &
 &      + y2  *(-11056.0_QP &
 &      + y2  *( 85680.0_QP )))))))))
  case(6)
  y4 = y2*y2
  y6 = y4*y2
  f = f + y6  *(-120.0_QP + y*(-360.0_QP + y*(-420.0_QP  &
 &      + y2  *(504.0_QP      &
 &      + y2  *(-1320.0_QP    &
 &      + y2  *(5148.0_QP     &
 &      + y2  *(-27300.0_QP   &
 &      + y2  *(187952.0_QP   &
 &      + y2  *(-1.62792e6_QP)))))))))

  case(7)
  y3 = y2*y
  y4 = y2*y2
  y7 = y4*y3
  f = f + y7  *(720.0_QP + y*(2520.0_QP + y*(3360.0_QP &
 &      + y2  *(-5040.0_QP   &
 &      + y2  *(15840.0_QP   &
 &      + y2  *(-72072.0_QP  &
 &      + y2  *(436800.0_QP  &
 &      + y2  *(-3.383136e6_QP))))))))

  case(8)

  y4 = y2*y2
  y8 = y4*y4
  f = f + y8  *(-5040.0_QP + y*(-20160.0_QP + y*(-30240.0_QP &
 &      + y2  *( 55440.0_QP     &
 &      + y2  *(-205920.0_QP    &
 &      + y2  *( 1.08108e6_QP   &
 &      + y2  *(-7.4256e6_QP    &
 &      + y2  *( 6.4279584e7_QP ))))))))


  end select
  
  pgf = f

  return
end function

end module
